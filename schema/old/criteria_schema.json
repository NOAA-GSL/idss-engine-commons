{
  "$schema": "http://json-schema.org/draft/2020-12/schema#",
  "$id": "https://idss.engine.com/critera.schema.json",

  "$def": {

    "identifier": {
      "description": "The unique identifier for this criteria",
      "type": "object",
      "properties": {
        "originator": {
          "description": "The source of this critera (IMSp, or IDSS-E)",
          "type": "string"
        },
        "key": {
	  "description": "Any key guaranteed to be unique for the originator (eg. uuid)",
          "type": "string"
        },
        "issueDt": {
	  "desciption": "A date/time string specifying when the input data is available",
          "type": "string"
        }
      },
      "required": [
        "originator",
        "key",
        "issueDt"
      ]
    },

    "tags": {
      "desciption": "User specified set of tag, either keyValue pairs of just values",
      "type": "object",
      "properties": {
        "keyValues": {
	  "description": "List of keyValue pairs",
          "type": "array",
	  "items": {
	    "type": "object",
  	    "additionalProperties": { 
    	      "type": "array",
    	      "items": {
       		"type": "string"
    	      }
            }
	  }
        },
        "values": {
	  "description": "List of stand alone tags",
          "type": "array",
          "items": {
              "type": "string"
          }
        }
      },
      "anyOf": [
        {
          "required": [
            "keyValues"
          ]
        },
        {
          "required": [
            "values"
          ]
        } 
      ]
    },

    "timing": {
      "description": "Date/time string specifying the start and end valid times",
      "type": "object",
      "properties": {
        "start": {
          "type": "string"
        },
        "end": {
          "type": "string"
        },
        "valids": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "oneOf": [
        "required": [ "start", "end" ],
        "required": "valid"
      ]
    },

    "location": {
      "type": "object",
      "properties": {
        "key": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "geometry": {
          "type": "array",
          "items": { 
            "type": "string"
          },
          "minitems": 1
        },
        "buffer": {
          "type": "number"
        },
        "bufferUnits": {
          "type": "string"
        }
      },
      "required": [
        "key",
        "name",
        "geometry",
        "buffer",
        "bufferUnits"
      ]
    },

    "variableMapping": {
      "description": "Definition of piecewise mapping of a variable to a linear space",
      "type": "object",
      "properties": {
        "controlPoints": {
          "description": "List of values that define piecewise linear mapping ('Inf' or number)",
          "type": "array",
          "items": {
	    "oneOf": [
              {"type": "string"},
              {"type": "number"}
            ]
          },
          "minItems": 2
        },
        "startWeights": {
          "description": "Scalar weight for start of piecewise linear semgment",
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 2
        },
        "endWeights": {
          "description": "Scalar weight for end of piecewise linear semgment",
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 2
        },
        "min": {
          "description": "Part of shorthand notation for specifying single linear mapping",
          "type": "integer"
        },
        "max": {
          "description": "Part of shorthand notation for specifying single linear mapping",
          "type": "integer"
        },
        "clip": {
          "description": "Part of shorthand notation for specifying single linear mapping",
          "type": "boolean"
        }
      },
      "oneOf": [
        {
          "required": [
            "controlPoints",
            "startWeights",
            "endWeights"
          ]
	},
	{
          "required": [
            "min",
            "max",
            "clip"
          ]
	}
      ]
    },

    "variable": {
      "type": "object",
      "properties": {
        "source": {
          "description": "List of weather (or non-weather in the future)  models to be evaluated",
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1
        },
        "field": {
          "type": "string"
        },
        "units": {
          "type": "string"
        },
        "relational": {
          "type": "string"
        },
        "value": {
          "type": "string"
        },
        "secondValue": {
          "type": "string"
        },
	"mapping": { 
	  "$ref": "#/$def/variableMapping"
        },
        "required": [
          "source",
          "field",
          "units",
          "relational",
          "value",
          "mapping"
        ]
      }
    },    

    "data": {
      "description": "Input to condition",
      "type": "object",
      "properties": {
        "variable": { "$ref": "#/$def/variable" },
        "join": { "$ref": "#/$def/join" }
      },
      "oneOf": [
        {"required": "variable"},
        {"required": "join"}
      ]
    },

    "join": {
      "description": "Specification for a logical join",
      "type": "object",
      "properties": {
        "type": {
 	  "description": "The type of join (AND or OR)",
          "type": "string"
        },
        "parts": {
          "description": "List of data to be joined",
          "type": "array",
          "items": {
            "$ref": "#/$def/data"
          },
	  "minItems": 2
	}
      }
    },

    "condition": {
      "type": "object",
      "properties": {
        "severity": { "type": "string" },
        "accuracy": { "type": "number" },
        "arealPercentage": { "type": "integer" },
        "duration": { "type": "integer" },
	"data": { "$ref": "#/$def/data" }
      }	
    }
  },

  "title": "Criteria",
  "description": "Full specification for a Event Criteria",
  "type": "object",
  "properties": {
    "name": { "type": "string" },
    "identifier": {
      "$ref": "#/$def/identifier"
    },
    "tags": {
      "$ref": "#/$def/tags"
    },
    "timing": {
      "$ref": "#/$def/timing"
    },
    "location": {
      "$ref": "#/$def/location"
    },
    "conditions": {
      "description": "List of conditions to be evaluated",
      "type": "array",
      "items": {
        "$ref": "#/$def/condition"
      },
      "minitems": 1
    }
  },
  "required": [
    "name",
    "identifier",
    "timing",
    "location",
    "conditions"
  ]
}
